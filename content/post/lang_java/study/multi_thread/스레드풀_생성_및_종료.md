---
title: "[Java] 스레드풀 생성 및 종료"
description: ""
date: "2022-10-16T11:40:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"


---
<!--more-->

## 스레드풀 생성

- ExecutorService 구현 객체는 Executors 클래스의 다음 두 가지 메소드 중 하나를 이용해서 간편하게 생성 가능
    
    
    | 메소드명(매개 변수) | 초기 스레드 수 | 코어 스레드 수 | 최대 스레드 수 |
    | --- | --- | --- | --- |
    | newCachedThreadPool() | 0 | 0 | Integer.MAX_VALUE |
    | newFixedThreadPool(int nThreads) | 0 | nThreads | nThreads |
    - 초기 스레드 수 : ExecutorService 객체가 생성될 때 기본적으로 생성되는 스레드 수
    - 코어 스레드 수 : 스레드 수가 증가된 후 사용되지 않는 스레드를 스레드풀에서 제거할 때 최소한 유지해야 할 스레드 수
    - 최대 스레드 수 : 스레드 풀에서 관리하는 최대 스레드 수
- `newCachedThreadPool()` 메소드로 생성된 스레드풀의 특징은 초기 스레드 개수와 코어 스레드 개수는 0개
    - 스레드 개수보다 작업 개수가 많으면 새 스레드를 생성시켜 작업을 처리
    - 이론적으로는 int값이 가질 수 있는 최대값만큼 스레드가 추가
        - OS의 성능과 상황에 따라 달라진다.
    - 1개 이상의 스레드가 추가되었을 경우 60초 동안 추가된 스레드가 아무 작업을 하지 않으면 추가된 스레드를 종료하고 풀에서 제거
    - `newCachedThreadPool()`을 호출해서 ExecutorService 구현 객체를 얻는 코드
        
        ```java
        ExecutorService executorService = Executors.newCachedThreadPool();
        ```
        
- `newFixedThreadPool(int nThreads)` 메소드로 생성된 스레드풀의 초기 스레드 개수는 0개
    - 코어 스레드 수는 nThreads
    - 스레드 개수보다 작업 개수가 많으면 새 스레드를 생성시키고 작업을 처리
    - 최대 스레드 개수는 매개값으로 준 nThreads
    - 이 스레드풀은 스레드가 작업을 처리하지 않고 놀고 있더라도 스레드 개수가 줄지 않는다.
    - CPU 코어의 수만큼 최대 스레드를 사용하는 스레드풀을 생성
        
        ```java
        ExecutorService executorService = Executors.newFixedThreadPool(
        	Runtime.getRuntime().availableProcessors()
        );
        ```
        
- `newCachedThreadPool()`과 `newFixedThreadPool()` 메소드를 사용하지 않고 코어 스레드 개수와 최대 스레드 개수를 설정하고 싶다면 직접 ThreadPoolExecutor 객체를 생성하면 된다.
    - 위의 두 가지 메소드로 내부적으로 ThreadPoolExecutor 객체를 생성해서 리턴
    - ex) 초기 스레드 0개, 코어 스레드 3개, 최대 스레드 100개인 스레드풀 생성
        - 코어 스레드 3개를 제외한 나머지 추가된 120초 동안 놀고 있을 경우 해당 스레드를 제거해서 스레드 수를 관리
        
        ```java
        ExecutorService threadPool = new ThreadPoolExecutor(
        	3,    // 코어 스레드 개수
        	100,  // 최대 스레드 개수
        	120L, // 놀고 있는 시간
        	TimeUnit.SECONDS, // 놀고 있는 시간 단위
        	new SynchronousQueue<Runnable>() // 작업 큐
        );
        ```
        

---

## 스레드풀 종료

- 스레드풀의 스레드는 기본적으로 데몬 스레드가 아니기 때문에 main 스레드가 종료되더라도 작업을 처리하기 위해 계속 실행 상태로 남아있다.
    - `main()` 메소드가 실행이 끝나더라도 애플리케이션 프로세스는 종료되지 않는다.
- 애플리케이션을 종료하려면 스레드풀을 종료시켜 스레드들이 종료 상태가 되도록 처리해주어야 한다.
- ExecutorService는 종료와 관련해서 다음 세 개의 메소드들을 제공
    
    
    |  리턴 타입 | 메소드명(매개 변수) | 설명 |
    | --- | --- | --- |
    | void | shutdown() | 현재 처리 중인 작업뿐만 아니라 작업 큐에 대기하고 있는 모든 작업을 처리한 뒤에 스레드풀을 종료시킨다. |
    | List<Runnable> | shutdownNow() | 현재 작업 처리 중인 스레드를 interrupt해서 작업 중지를 시도하고, 스레드풀을 종료시킨다. 리턴값은 작업 큐에 있는 미처리된 작업(Runnable)의 목록이다. |
    | boolean | awaitTermination(long timeout, TimeUnit unit) | shutdown() 메소드 호출 이후, 모든 작업 처리를 timeout 시간 내에 완료하면 true를 리턴하고, 완료하지 못하면 작업 처리 중인 스레드를 interrupt하고 false를 리턴 |
    - 남아있는 작업을 마무리하고 스레드풀을 종료할 때에는 `shutdown()`을 일반적으로 호출
    - 남아있는 작업과는 상관없이 강제로 종료할 때에는 `shutdownNow()`를 리턴
    
    ```java
    executorService.shutdown();
    
    executorService.shutdownNow();
    ```
    

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판