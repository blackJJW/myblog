---
title: "[Java] 스레드풀, 콜백 방식의 작업 완료 통보"
description: ""
date: "2022-10-26T23:40:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"


---
<!--more-->

- 콜백이란 애플리케이션이 스레드에게 작업 처리를 요청한 후, 스레드가 작업을 완료하면 특정 메소드를 자동 실행하는 기법
    - 이때 자동 실행되는 메소드를 콜백 메소드라고 한다.
    
    ### 블로킹 방식과 콜백 방식을 비교
    
    ![Untitled](/images/lang_java/multi_thread/스레드풀,_콜백_방식의_작업_완료_통보/Untitled.png)
    
    - 블로킹 방식은 작업 처리를 요청한 후 작업이 완료될 때까지 블로킹
    - 콜백 방식은 작업 처리를 요청한 후 결과를 기다릴 필요 없이 다른 기능 수행 가능
        - 이유는 작업 처리가 완료되면 자동적으로 콜백 메소드가 실행되어 결과를 알 수 있기 때문
- `ExecutorService`는 콜백을 위한 별도의 기능을 제공하지 않는다.
    - 하지만 Runnable 구현 클래스를 작성할 때 콜백 기능을 구현 가능
    - 먼저 콜백 메소드를 가진 클래스가 있어야 한다.
        - 직접 정의해도 좋고, `java.nio.channels.CompletionHandler`를 이용해도 좋다.
        - `java.nio.channels.CompletionHandler`는 NIO 패키지에 포함되어 있는데 비동기 통신에서 콜백 객체를 만들 때 사용된다.
- `CompletionHandler`를 이용해서 콜백 객체를 만드는 방법
    - `CompletionHandler` 객체를 생성하는 코드
    
    ```java
    CompletionHandler<V, A> callback = new CompletionHandler<V, A>() {
    	@Override
    	public void completed(V result, A attachment){
    	}
    	@Override
    	public void failed(Throwable exc, A attachment){
    	}
    };
    ```
    
    - `CompletionHandler`는 `completed()`와 `failed()` 메소드가 존재
        - `completed()`는 작업을 정상 처리 완료했을 때 호출되는 콜백 메소드
        - `failed()`는 작업 처리 도중 예외가 발생했을 때 호출되는 콜백 메소드
    - `CompletionHandler`의 V 타입 파라미터는 결과값의 타입
        - A는 첨부값의 타입
            - 첨부값은 콜백 메소드에 결과값 이외에 추가적으로 전달하는 객체라고 생각하면 된다.
            - 만약 첨부값이 필요 없다면 A는 `Void`로 지정
- 작업 처리 결과에 따라 콜백 메소드를 호출하는 Runnable 객체
    
    ```java
    Runnable task = new Runnable(){
    	@Override
    	public void run(){
    		try{
    			// 작업 처리
    			V result = ..;
    			callback.completed(result, null); // 작업을 정상 처리했을 경우 호출
    		} catch(Exception e){
    			callback.failed(e, null); // 예외가 발생 했을 경우 호출
    		}
    	}
    };
    ```
    
    - 작업 처리가 정상적으로 완료되면 `completed()` 콜백 메소드를 호출해서 결과값을 전달
    - 예외가 발생하면 `failed()` 콜백 메소드를 호출해서 예외 객체를 전달
- ex) 콜백 방식의 작업 완료 통보받기
    - 두 개의 문자열을 정수화해서 더하는 작업을 처리하고 결과를 콜백 방식으로 통보
    - 첫 번째 작업은 “3”, “3”을 주었고, 두 번째 작업은 “3”, “삼”을 주었다.
    - 첫 번째 작업은 정상적으로 처리되기 때문에 `completed()`가 자동 호출
    - 두 번째 작업은 `NumberFormatException`이 발생되어 `failed()` 메소드가 호출
    - CallbackEx.java
    
    ```java
    import java.nio.channels.CompletionHandler;
    import java.util.concurrent.ExecutorService;
    import java.util.concurrent.Executors;
    
    public class CallbackEx {
    	private ExecutorService executorService;
    	
    	public CallbackEx() {
    		executorService = Executors.newFixedThreadPool(
    				Runtime.getRuntime().availableProcessors()
    				);
    	}
    	
    	
    	// 콜백 메소드를 가진 CompletionHandler 객체 생성
    	private CompletionHandler<Integer, Void> callback = 
    			new CompletionHandler<Integer, Void>(){
    		/* Integer -> 결과 타입
    		 * Void -> 첨부 타입
    		 * */
    		@Override
    		public void completed(Integer result, Void attachment) {
    			System.out.println("completed() 실행 : " + result);
    		}
    		
    		
    		/* Throwable -> 예외 타입
    		 * Void -> 첨부 타입
    		 * */
    		@Override
    		public void failed(Throwable exc, Void attachment) {
    			System.out.println("failed() 실행 : " + exc.toString());
    		}
    	};
    	
    	public void doWork(final String x, final String y) {
    		Runnable task = new Runnable() {
    			@Override
    			public void run() {
    				try {
    					int intX = Integer.parseInt(x);
    					int intY = Integer.parseInt(y);
    					int result = intX + intY;
    					
    					callback.completed(result, null); // 정상 처리했을 경우 호출
    				} catch(NumberFormatException e) {
    					callback.failed(e, null); // 예외가 발생했을 경우 호출
    				}
    			}
    		};
    		executorService.submit(task); // 스레드풀에게 작업 처리 요청
    	}
    	
    	public void finish() {
    		executorService.shutdown(); // 스레드풀 종료
    	}
    	public static void main(String[] args) {
    		CallbackEx example = new CallbackEx();
    		example.doWork("3", "3");
    		example.doWork("3", "삼");
    		example.finish();
    	}
    
    }
    ```
    
    ![Untitled](/images/lang_java/multi_thread/스레드풀,_콜백_방식의_작업_완료_통보/Untitled%201.png)
    

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판