---
title: "[Java] NIO, TCP 넌블로킹 채널, 채널 작업 처리"
description: ""
date: "2023-02-04T17:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- 작업 스레드가 해야 할 일은 선택된 키셋에서 SelectionKey를 하나씩 꺼내어 작업 유형별로 채널 작업을 처리하는 것
- SelectionKey가 어떤 작업 유형인지 알아내는 방법
    - SelectionKey의 메소드 중에서 어떤 것이 true를 리턴하는지 조사하면 된다.
    
    | 리턴 타입 | 메소드명(매개 변수) | 설명 |
    | --- | --- | --- |
    | boolean | isAcceptable() | 작업 유형이 OP_ACCEPT인 경우 |
    | boolean | isConnectable() | 작업 유형이 OP_CONNECT인 경우 |
    | boolean | isReadable() | 작업 유형이 OP_READ인 경우 |
    | boolean | isWritable() | 작업 유형이 OP_WRITE인 경우 |
- 작업 스레드가 작업 유형별로 채널 작업을 처리하는 방법
    
    ```java
    Thread thread = new Thread() { // 스레드 생성
    	@Override
    	public void run() {
    		while(ture) {
    			try {
    				// 작업 처리 준비된 키 감지
    				int keyCount = selector.select();
    				// 키가 없을 경우 루프 처음으로 돌아감
    				if(keyCount == 0 ) { continue; }
    				Set<SelectionKey> selectedKeys
    					= selector.selectedKeys(); // 선택된 키셋 얻기
    				Iterator<SelectionKey> iterator 
    					= selectedKeys.iterator(); // 반복자 얻기
    				while (iterator.hasNext()) {
    					SelectionKey selectionKey 
    						= iterator.next(); // 키를 하나씩 꺼내옴
    					if (selectionKey.isAcceptable()) {
    						// 연결 수락 작업 처리
    					} else if (selectionKey.isReadable()) {
    						// 읽기 작업 처리
    					} else if (selectionKey.isWritable()) {
    						// 쓰기 작업 처리
    					}
    					// 선택된 키셋에서 처리 완료된 SelectionKey를 제거
    					iterator.remove(); 
    				}
    			} catch(Exceptione e) {
    				break;
    			}
    		}
    	}
    };
    thread.start(); // 스레드 실행
    ```
    
- 작업 스레드가 채널 작업을 하려면 채널 객체가 필요
    - SelectionKey의 `channel()` 메소드를 호출하면 얻을 수 있다.
    - 작업 유형이 `OP_ACCEPT`일 경우, 연결 수락 작업 처리에서 필요한 ServerSocketChannel을 얻는 코드
    
    ```java
    ServerSocketChannel serverSocketChannel
    	= (ServerSocketChannel) selectionKey.channel();
    ```
    
- 작업 스레드가 채널 작업을 처리하다 보면 채널 객체 이외에 다른 객체가 필요할 수도 있다.
    - 이러한 객체는 SelectionKey에 첨부해 두고, 사용할 수 있다.
    - SelectionKey의 `attach()` 메소드는 객체를 첨부
        - `attachment()` 메소드는 첨부된 객체를 얻을 때 사용
    - Client 객체를 SelectionKey에 첨부하고, 얻어내는 코드
    
    ```java
    // [ 객체 첨부하기 ]
    Client client = new Client(socketChannel);
    SelectionKey selectionKey 
    	= socketChannel.register(selector, SelectionKey.OP_READ);
    selectionKey.attach(client): // 객체를 첨부시킴
    
    // [ 첨부된 객체 얻기 ]
    if (selectionKey.isReadable()) {
    	// 첨부된 객체 얻기
    	Client client = (Client) selectionKey.attachment();
    	...
    }
    ```
    

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판