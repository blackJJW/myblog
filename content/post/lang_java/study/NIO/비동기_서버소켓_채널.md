---
title: "[Java] NIO, TCP 비동기 서버소켓 채널"
description: ""
date: "2023-02-05T19:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- AsynchronousServerSocketChannel은 두 가지 정적 메소드인 `open()`을 호출해서 얻을 수 있다.
- 기본 비동기 채널 그룹에 포함되는 AsynchronousServerSocketChannel을 얻는 방법은 매개값 없는 `open()` 메소드를 호출하는 것
    
    ```java
    AsynchronousServerSocketChannel asynchronousServerSocketChannel 
    	= AsynchronousServerSocketChannel.open();
    ```
    
- 별도로 비동기 채널 그룹을 생성하고 여기에 포함되는 AsynchronousServerSocketChannel을 얻고 싶다면 비동기 채널 그룹을 매개값으로 갖는 `open()` 메소드를 호출
    
    ```java
    AsynchronousChannelGroup channelGroup
    	= AsynchronousChannelGroup.withFixedThreadPool(
    	Runtime.getRuntime().availableProcessors(),
    	Executors.defaultThreadFactory()
    );
    AsynchronousServerSocketChannel asynchronousServerSocketChannel
    	= AsynchronousServersocketChannel.open(channelGroup);
    ```
    
- AsynchronousServerSocketChannel을 생성하고 나서는 포트 바인딩을 위해 `bind()` 메소드를 호출
    
    ```java
    asynchronousServerSocketChannel.bind(new InetSocketAddress(5001));
    ```
    
- AsynchronousServerSocketChannel을 더 이상 사용하지 않을 경우에는 `close()` 메소드를 호출해서 서버가 사용한 포트를 언바인딩해준다.
    
    ```java
    asynchronousServerSocketChannel.close();
    ```
    
- AsynchronousServerSocketChannel은 연결 수락 작업을 스레드풀을 이용해서 비동기로 처리
    - `accept()` 메소드를 호출하는 코드
    
    ```java
    accept(A attachment, 
    	CompletionHandler<AsynchronousSocketChannel, A> handler);
    ```
    
    - 첫 번째 매개값은 콜백 메소드의 매개값으로 제공할 첨부 객체
        - 연결 수락 작업에는 별도의 첨부 객체가 필요하지 않기 때문에 null을 지정
    - 두 번째 매개값은 콜백 메소드를 가지고 있는 `CompletionHandler<AsynchronousSocketChannel, A>` 구현 객체
        - A는 첨부 객체 타입
            - 연결 수락 작업에는 별도의 첨부 객체가 필요하지 않기 때문에 Void로 지정
    - `accept()` 메소드를 호출하는 기본 뼈대
    
    ```java
    asynchronousServerSocketChannel.accept(null,
    	new CompletionHandler<AsynchronousSocketChannel, Void>() {
    	@Override
    	public void completed(AsynchronousSocketChannel asynchronousSocketChannel,
    												Void attachment) {
    		// 연결 수락 후 실행할 코드
    		// accept() 재호출
    		asynchronousServerSocketChannel.accept(null, this);
    	}
    	@Override
    	public void failed(Throwable exc, Void attachment) {
    		// 연결 수락 실패 시 실행할 코드
    	}
    });
    ```
    
    - `completed()` 메소드는 연결 수락이 완료되었을 때 스레드풀의 스레드가 호출
        - 첫 번째 매개값은 연결 수락 후 리턴된 AsynchronousSocketChannel이 대입
        - 두 번째 매개값은 첨부 객체
            - `accept()`의 첫 번째 매개값이 null이므로 null이 대입
    - 만약 스레드풀의 스레드가 연결 수락에 문제가 생겨 예외를 발생시키면 `failed()`가 호출
        - 첫 번째 매개값은 예외 객체
        - 두 번째 매개값은 첨부 객체
            - `accept()`의 첫 번째 매개값이 null이므로 null이 대입
    - 주목할 점은 `accept()`를 반복해서 호출하는 무한 루프가 없다는 것
        - 대신 `completed()` 메소드 끝에 `accept()`를 재호출해서 반복적으로 클라이언트의 연결 수락 작업을 수행

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판