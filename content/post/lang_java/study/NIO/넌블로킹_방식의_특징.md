---
title: "[Java] NIO, TCP 넌블로킹 채널, 넌블로킹 방식의 특징"
description: ""
date: "2023-02-04T14:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- 블로킹 방식
    - 언제 클라이언트가 연결 요청을 할지 모르기 때문에 `accept()`에서 블로킹된다.
    - 언제 클라이언트가 데이터를 보낼지 모르므로 `read()` 메소드는 항상 데이터를 받을 준비를 하기 위해 블로킹 된다.
    - ServerSocketChannel과 연결된 SocketChannel당 하나의 스레드가 할당되어야 한다.
    - 연결된 클라이언트가 많을 수록 스레드의 수가 증가하고 서버에 문제를 유발할 수 있다.
    - 이 문제를 해결하기 위해 스레드풀(ExecutorService)을 사용
- 넌블로킹 방식
    - 자바는 블로킹 방식의 또 다른 해결책으로 넌블로킹 방식을 지원
    - 넌블로킹 방식은 `correct()`, `accept()`, `read()`, `write()` 메소드에서 블로킹이 없다.
    - 클라이언트의 연결 요청이 없으면 `accept()`는 즉시 null을 리턴
    - 클라이언트가 데이터를 보내지 않으면 `read()`는 즉시 0을 리턴
        - 매개값으로 전달한 ByteBuffer에는 어떤 데이터도 저장되지 않는다.
    - 넌블로킹 방식에서 클라이언트가 연결 요청을 하지 않으면 무한 루프를 계속 돈다.
        
        ```java
        while(true) {
        	SocketChannel socketChannel 
        		= serverSocketChannel.accept();
        	...
        }
        ```
        
        - `accept()` 메소드가 블로킹되지 않고 바로 리턴
            - 클라이언트가 연결 요청을 보내기 전까지 while 블록 내의 코드가 쉴새 없이 실행
            - CPU가 과도하게 소비되는 문제 발생
    - 넌블로킹은 이벤트 리스터 역할을 하는 셀렉터(Selector)를 사용
        - 넌블로킹 채널에 Selector를 등록해 놓으면 클라이언트의 연결 요청이 들어오거나 데이터가 도착할 경우
            - 채널은 Selector에 통보
        - Selector는 통보한 채널들을 선택해서 작업 스레드가 `accept()` 또는 `read()` 메소드를 실행해서 즉시 작업을 처리하도록 한다.
- Selector는 멀티 채널의 작업을 싱글 스레드에서 처리할 수 있도록 해주는 멀티플렉서(multiplexor) 역할을 수행
    1. 채널은 Selector에 자신을 등록할 때 작업 유형을 키(SelectionKey)로 생성
        - Selector의 관심키셋(interest-set)에 저장
    2. 클라이언트가 처리 요청
    3. Selector는 관심키셋에 등록된 키 중에서 작업 처리 준비가 된 키를 선택된 키셋(selected-set)에 별도로 저장
    4. 작업 스레드가 선택된 키셋에 있는 키를 하나씩 꺼내어 키와 연관된 채널 작업을 처리
        - 작업 스레드가 선택된 키셋에 있는 모든 키를 처리하게 되면 선택된 키셋은 비워진다.
        - Selector는 다시 관심키셋에서 작업 처리 준비가 된 키들을 선택해서 선택된 키셋을 채운다.
    
    ![Untitled](/images/lang_java/NIO/넌블로킹_방식의_특징/Untitled.png)
    
    - 넌블로킹에서 작업 스레드를 꼭 하나만 사용할 필요는 없다.
    - 채널 작업 처리 시(④) 스레드풀을 사용할 수 있다.
    - 작업 스레드가 블로킹되지 않기 때문에 적은 수의 스레드로 많은 양의 작업을 고속으로 처리할 수 있다.
        - 블로킹 방식보다는 서버의 성능이 향상될 수 있다.

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판