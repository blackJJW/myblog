---
title: "[Java] NIO, TCP 넌블로킹 채널, 선택된 키셋"
description: ""
date: "2023-02-04T16:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- Selector를 구동하려면 `select()` 메소드를 호출해야 한다.
    - `select()`는 관심키셋에 저장된 SelectionKey로부터 작업 처리 준비가 되었다는 통보가 올 때까지 대기(블로킹)
    - 최소한 하나의 SelectionKey로부터 작업 처리 준비가 되었다는 통보가 오면 리턴
        - 리턴값은 통보를 해온 SelectionKey의 수
    
    ### 세 가지 종류의 `select()` 메소드
    
    | 리턴 타입 | 메소드명(매개 변수) | 설명 |
    | --- | --- | --- |
    | int | select() | 최소한 하나의 채널이 작업 처리 준비가 될 때까지 블로킹 |
    | int | select(long timeout) | select()와 동일, 주어진 시간(밀리세컨드) 동안만 블로킹 |
    | int | selectNow() | 호출 즉시 리턴. 작업 처리 준비된 채널이 있으면 채널 수를 리턴, 없다면 0을 리턴 |
    - 주로 첫 번째 `select()`를 사용
        - 이 메소드는 블로킹되므로 UI 및 이벤트 처리를 하는 스레드에서 호출되면 안 된다.
        - 별도의 작업 스레드를 생성해서 실행해야 한다.
        - `select()`가 리턴하는 다음 세 가지
            - 채널이 작업 처리 준비가 되었다는 통보를 할 때
            - Selector의 `wakeup()` 메소드를 호출할 때
            - `select()`를 호출한 스레드가 인터럽트될 때
- ServerSocketChannel은 작업 유형이 `OP_ACCEPT` 하나 밖에 없다.
    - SocketChannel은 상황에 따라서 읽기 작업과 쓰기 작업을 번갈아가며 작업 유형을 변경할 수 있다.
    - 채널의 작업 유형이 변경되면 SelectionKey의 작업 유형을 `interestOps()` 메소드로 변경해샤 작업 스레드가 올바르게 채널 작업을 할 수 있다.
    - Selectionkey의 작업 유형을 `OP_WRITE`로 변경하는 코드
    
    ```java
    selectionKey.interestOps(SelectionKey.OP_WRITE);
    selector.wakeup();
    ```
    
- SelectionKey의 작업 유형이 변경될 경우
    - Selector의 `wakeup()` 메소드를 호출해서 블로킹되어 있는 `select()`를 즉시 리턴
    - 변경된 작업 유형을 감지하도록 `select()`를 다시 실행해야 한다.
- `select()`  메소드가 1 이상의 값을 리턴할 경우
    - `selectedKeys()` 메소드로 작업 처리 준비된 SelectionKey들을 Set 컬렉션으로 얻는다.
        - 이것이 선택된 키셋
    
    ```java
    int keyCount = selector.select();
    if(keyCount > 0) {
    	Set<SelectionKey> selectedKeys = selector.selectedKeys();
    }
    ```
    

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판