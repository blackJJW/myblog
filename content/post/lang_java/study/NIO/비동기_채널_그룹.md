---
title: "[Java] NIO, TCP 비동기 채널 그룹"
description: ""
date: "2023-02-05T18:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- 비동기 채널 그룹은 같은 스레드풀을 공유하는 비동기 채널들의 묶음
- 하나의 스레드풀을 사용한다면 모든 비동기 채널은 같은 채널 그룹에 속해야 한다.
    
    ![Untitled](/images/lang_java/NIO/비동기_채널_그룹/Untitled.png)
    
- 비동기 채널을 생성할 때 채널 그룹을 지정하지 않으면 기본 비동기 채널 그룹이 생성
    - 기본 비동기 채널 그룹은 내부적으로 스레드풀을 생성
    
    ```java
    new ThreadPoolExecutor(
    	0, Integer.MAX_VALUE,
    	Long.MAX_VALUE, TimeUnit.MILLISECONDS,
    	new SynchronousQueue<Runnable>(),
    	threadFactory
    );
    ```
    
    - 이론적으로 `Integer.MAX_VALUE`개만큼 스레드가 증가할 수 있도록 되어 있다.
        - 스레드풀은 대부분 최대 스레드 수를 지정해서 사용
        - AsynchronousChannelGroup을 직접 생성하고 사용하는 것이 일반적
    
    ```java
    AsynchronousChannelGroup channelGroup
    	= AsynchronousChannelGroup.withFixedThreadPool(
    		최대스레드수,
    		Executors.defaultThreadFactory()
    );
    ```
    
- CPU 코어의 수만큼 스레드를 관리하는 스레드풀을 생성하고 이용하는 비동기 채널 그룹을 생성
    
    ```java
    AsynchronousChannelGroup channelGroup
    	= AsynchronousChannelGroup.withFixedThreadPool(
    		Runtime.getRuntime().availableProcessors(),
    		Executors.defaultThreadFactory()
    );
    ```
    
    - 이렇게 생성된 비동기 채널 그룹은 비동기 채널을 생성할 때 매개값으로 사용
    - 비동기 채널 그룹이 더 이상 사용하지 않고 종료할 경우에는 `shutdown()`과 `shutdownNow()` 메소드를 호출할 수 있다.
    
    ```java
    channelGroup.shutdown();
    channelGroup.shutdownNow();
    ```
    
    - `shutdown()`은 비동기 채널 그룹을 종료하겠다는 의사만 전달할 뿐 비동기 채널 그룹을 종료하지 않는다.
        - 비동기 채널 그룹에 포함된 모든 비동기 채널이 닫히면 비로소 비동기 채널 그룹이 종료
        - `shutdown()` 메소드를 호출한 이후에 새로운 비동기 채널을 비동기 채널 그룹에 포함시키면 ShutdownChannelGroupException이 발생
    - `shutdownNow()`는 강제적으로 비동기 채널 그룹에 포함된 비동기 채널을 닫아버리고 비동기 채널 그룹을 종료
        - 완료 콜백을 실행하고 있는 스레드는 종료되거나, 인터럽트되지 않는다.

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판