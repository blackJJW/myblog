---
title: "[Java] NIO, TCP 블로킹 채널, 서버소켓 채널 생성과 연결 수락"
description: ""
date: "2023-01-29T16:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- 서버를 개발하려면 우선 ServerSocketChannel 객체를 얻어야 한다.
    - ServerSocketChannel은 정적 메소드인 `open()`으로 생성
    - 블로킹 방시긍로 동작시키기 위해 `configureBlocking(true)` 메소드를 호출
    - 기본적으로 블로킹 방식으로 동작
        - 명시적으로 설정하는 이유는 넌블로킹과 구분하기 위해
    - 포트에 바인딩하기 위해서는 `bind()` 메소드가 호출되어야 한다.
        - 포트 정보를 가진 InetSocketAddress 객체를 매개값으로 주면 된다.
    
    ```java
    ServerSocketChannel serverSocketChannel 
    		= ServerSocketChannel.open();
    serverSocketChannel.configureBlocking(true);
    serverSocketChannel.bind(new InetSocketAddress(5001));
    ```
    
- 포트 바인딩까지 끝났다면 ServerSocketChannel은 클라이언트 연결 수락을 위해 `accept()` 메소드를 실행해야 한다.
    - `accept()` 메소드는 클라이언트가 연결 요청을 하기 전까지 블로킹된다.
        - UI 및 이벤트를 처리하는 스레드에서 `accept()` 메소드를 호출하지 않도록 한다.
    - 클라이언트가 연결 요청을 하면 `accept()`는 클라이언트와 통신할 SocketChannel을 만들고 리턴
    
    ```java
    SocketChannel socketChannel = serverSocketChannel.accept();
    ```
    
- 연결된 클라이언트의 IP와 포트 정보를 알고 싶다면 SocketChannel의 `getRemoteAddress()` 메소드를 호출해서 SocketAddress를 얻으면 된다.
    - 실제 리턴되는 것은 InetSocketAddress 인스턴스이므로 다음과 같이 타입 변환 가능
    
    ```java
    InetSocketAddress socketAddress 
    		= (InetSocketAddress) socketChannel.getRemoteAddress();
    ```
    
    ### InetSocketAddress의 IP와 포트 정보를 리턴하는 메소드
    
    | 리턴 타입 | 메소드명(매개 변수) | 설명 |
    | --- | --- | --- |
    | String | getHostName() | 클라이언트 IP 리턴 |
    | int | getPort() | 클라이언트 포트 번호 리턴 |
    | String | toString() | “IP:포트번호” 형태의 문자열 리턴 |
- 더 이상 클라이언트를 위해 연결 수락이 필요 없다면 ServerSocketChannel의 `close()` 메소드를 호출해서 포트를 언바인딩시켜야 한다.
    - 다른 프로그램에서 해당 포트를 재사용할 수 있다.
    
    ```java
    serverSocketChannel.close();
    ```
    
- ex) 반복적으로 accept() 메소드를 호출해서 다중 클라이언트 연결을 수락하는 가장 기본적인 코드
    - ServerEx.java
    
    ```java
    import java.io.IOException;
    import java.net.InetSocketAddress;
    import java.nio.channels.ServerSocketChannel;
    import java.nio.channels.SocketChannel;
    
    public class ServerEx {
    
    	public static void main(String[] args) {
    		ServerSocketChannel serverSocketChannel = null;
    		
    		try {
    			serverSocketChannel = ServerSocketChannel.open();
    			serverSocketChannel.configureBlocking(true);
    			serverSocketChannel.bind(new InetSocketAddress(5001));
    			
    			while(true) {
    				System.out.println("[ 연결 기다림 ]");
    				SocketChannel socketChannel = serverSocketChannel.accept();
    				InetSocketAddress isa 
    					= (InetSocketAddress) socketChannel.getRemoteAddress();
    				System.out.println("[ 연결 수락함 ]" + isa.getHostName());
    			}
    		} catch(Exception e) {}
    		
    		if(serverSocketChannel.isOpen()) { // ServerSocketChannel이 열려있는 경우
    			try {
    				serverSocketChannel.close(); // ServerSocketChannel 닫기
    			} catch(IOException e1) {}
    		}
    	}
    }
    ```
    
    ![Untitled](/images/lang_java/NIO/서버소켓_채널_생성과_연결_수락/Untitled.png)
    

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판