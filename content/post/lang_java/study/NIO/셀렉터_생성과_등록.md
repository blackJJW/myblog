---
title: "[Java] NIO, TCP 넌블로킹 채널, 셀렉터 생성과 등록"
description: ""
date: "2023-02-04T15:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- Selector는 정적 메소드인 `open()` 메소드를 호출하여 생성
    - `open()` 메소드는 IOException이 발생할 수 있기 때문에 예외 처리가 필요
    
    ```java
    try {
    	Selector selector = Selector.open();
    } catch (IOException e) {}
    ```
    
- Selector에 등록할 수 있는 채널은 SelectorChannel의 하위 채널만 가능
    - TCP 통신에 사용되는 ServerSocketChannel, SocketChannel과 UDP 통신에 사용되는 DatagramChannel
        - 모두 SelectableChannel의 하위 클래스이므로 Selector에 등록 가능
    - 주의할 점은 넌블로킹으로 설정된 것만 가능
    - ServerSocketChannel을 넌블로킹으로 설정하는 코드
    
    ```java
    ServerSocketChannel serverSocketChannel 
    	= ServerSocketChannel.open();
    serverSocketChannel.configureBlocking(false);
    ```
    
    - SocketChannel을 넌블로킹으로 설정하는 코드
    
    ```java
    SocketChannel socketChannel = SocketChannel.open();
    socketChannel.configureBlocking(false);
    ```
    
- 각 채널은 `register()` 메소드를 이용해서 Selector에 등록
    - 첫 번째 매개값은 Selector
    - 두 번째 매개값은 채널의 작업 유형
        
        ```java
        SelectionKey selectionKey 
        	= serverSocketChannel.register(Selector sel, int ops);
        SelectionKey selectionKey
        	= socketChannel.register(Selector sel, int ops);
        ```
        
    - 두 번째 매개값으로 사용할 수 있는 작업 유형별 SelectionKey의 상수
        
        
        | SelectionKey의 상수 | 설명 |
        | --- | --- |
        | OP_ACCEPT | ServerSocketChannel의 연결 수락 작업 |
        | OP_CONNECT | SocketChannel의 서버 연결 작업 |
        | OP_READ | SocketChannel의 데이터 읽기 작업 |
        | OP_WRITE | SocketChannel의 데이터 쓰기 작업 |
    - `register()`는 채널과 작업 유형 정보를 담고 있는 SelectionKey를 리턴
    - ServerSocketChannel이 Selector에 자신의 작업 유형을 등록하는 코드
        
        ```java
        SelectionKey selectionKey 
        	= serverSocketChannel.register(selector, 
                                   SelectionKey.OP_ACCEPT);
        ```
        
        - ServerSocketChannel은 클라이언트 연결 수락 작업을 하므로 작업 유형은 `OP_ACCEPT`로 지정
    - SocketChannel이 Selector에 자신의 작업 유형을 등록하는 코드
        
        ```java
        SelectionKey selectionKey 
        	= socketChannel.register(selector, 
                             SelectionKey.OP_CONNECT);
        SelectionKey selectionKey 
        	= socketChannel.register(selector, 
                             SelectionKey.OP_READ);
        SelectionKey selectionKey 
        	= socketChannel.register(selector, 
                             SelectionKey.OP_WRITE);
        ```
        
    - 주의할 점은 동일한 SocketChannel로 두 가지 이상의 작업 유형을 등록할 수 없다.
        - 등록은 한 번만 하되, 작업 유형이 변경되면 이미 생성된 SelectionKey를 수정해야 한다.
    - `register()`가 리턴한 SelectionKey는 작업 유형 변경, 첨부 객체 저장, 채널 등록 취소 등을 할 때 사용
    - SelectionKey를 별도로 관리할 필요는 없다.
        - Selector를 등록하면 채널의 `keyFor()` 메소드로 SelectionKey를 언제든지 얻을 수 있기 때문
        
        ```java
        SelectionKey key = socketChannel.keyFor(selector);
        ```
        

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판