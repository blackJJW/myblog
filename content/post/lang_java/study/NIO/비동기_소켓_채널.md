---
title: "[Java] NIO, TCP 비동기 소켓 채널"
description: ""
date: "2023-02-05T20:00:30+09:00"
thumbnail: ""
categories:
  - "Java"
tags:
  - "Java"
  - "Network"

---
<!--more-->

- AsynchronousSocketChannel은 서버와 클라이언트에 각각 존재
    - 클라이언트가 AsynchronousSocketChannel을 생성해서 서버로 요청하면 서버와 AsynchronousServerSocketChannel은 연결 수락 후 AysnchronousSocketChannel을 생성해서 서로 통신할 수 있도록 해준다.
    - AsynchronousServerSocketChannel이 생성하는 AsynchronousSocketChannel은 자동적으로 AsynchronousServerSocketChannel과 같은 비동기 채널 그룹에 속하게 된다.
- 클라이언트에서 AsynchronousSocketChannel을 생성하려면 두 가지 `open()` 메소드를 사용할 수 있다.
    - 기본 비동기 채널에 포함되는 AsynchronousSocketChannel을 얻고 싶다면 매개값없는 `open()` 메소드를 호출하면 된다.
    
    ```java
    AsynchronousSocketChannel asynchronousSocketChannel
    	= AsynchronousSocketChannel.open();
    ```
    
    - 별도의 비동기 채널 그룹을 생성하고 여기에 포함되는 AsychronousSocketChannel을 얻고 싶다면 비동기 채널 그룹을 매개값으로 갖는 `open()` 메소드를 호출하면 된다.
    
    ```java
    AsynchronousChannelGroup channelGroup
    	= AsynchronousChannelGroup.withFixedThreadPool(
    	Runtime.getRuntime().availableProcessors(),
    	Executors.defaultThreadFactory()
    );
    AsynchronousSocketChannel asynchronousSocketChannel
    	= AsynchronousSocketChannel.open(channelGroup);
    ```
    
- AsynchronousSocketChannel을 더 이상 사용하지 않을 경우에는 `close()` 메소드를 호출해서 연결을 끊어준다.
    
    ```java
    asynchronousSocketChannel.close();
    ```
    
- 클라이언트가 생성하는 AsynchronousSocketChannel은 서버 연결 요청 작업을 스레드풀이 이용해서 비동기로 처리
    - `connect()` 메소드를 호출하는 코드
    
    ```java
    connect(SocketAddress remote, A attachment, 
    			  CompletionHandler<Void, A> handler);
    ```
    
    - 첫 번째 매개값은 서버 IP와 연결 포트 정보를 가진 InetSocketAddress 객체
    - 두 번째 매개값은 콜백 메소드의 매개값으로 제공할 첨부 객체
        - 연결 요청 작업에는 별도의 첨부 객체가 필요하지 않기 때문에 null을 지정
    - 세 번째 매개값은 `CompletionHandler<Void, A>` 구현 객체
        - A는 첨부 객체 타입
            - 연결 요청 작업에는 별도의 첨부 객체가 필요하지 않기 때문에 Void로 지정
    - `connect()` 메소드를 호출하는 기본 뼈대
    
    ```java
    asynchronousSocketChannel.connect(
    		new InetSocketAddress("localhost", 5001), 
    		null,
    		new CompletionHandler<Void, Void>() {
    	@Override
    	public void completed(Void result, Void attachment) {
    		// 연결 성공 후 실행할 코드
    	}
    	@Override
    	public void failed(Throwable e, Void attachment) {
    		// 연결 실패 후 실행할 코드
    	}
    }); 
    ```
    
    - `completed()` 메소드는 연결이 성공했을 때 스레드풀의 스레드를 호출
        - 첫 번째 매개값은 null이 대입
        - 두 번째 매개값은 첨부 객체
            - `connect()`의 두 번째 매개값이 null이므로 null이 대입
        - `completed()` 메소드에는 서버가 보낸 데이터를 받기 위한 코드가 일반적으로 작성
    - 스레드풀의 스레드가 연결 요청에 문제가 생겨 예외가 발생되면 `failed()`가 호출
        - 첫 번째 매개값은 예외 객체
        - 두 번째 매개값은 첨부 객체
            - `connect()`의 두 번째 매개값이 null이므로 null이 대입

---

## References

- 이것이 자바다 신용권의 Java 프로그래밍 정복 - 신용권 지음, 한빛미디어 출판